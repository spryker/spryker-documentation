<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" class="_Skins_HTML5___Top_Navigation" data-mc-search-type="Stem" data-mc-help-system-file-name="Default.xml" data-mc-path-to-help-system="../../../" data-mc-has-content-body="True" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="Capabilities|Capabilities|Search and Filter">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta charset="utf-8" />
        <meta name="description" content="" />
        <meta name="author" content="" /><title>Tutorial - Search Custom Setup</title>
        <link href="../../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" />
        <link href="../../../Skins/Fluid/Stylesheets/MadCapSearch.Google.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" />
        <link href="../../../Skins/Fluid/stylesheets/foundation.6.2.3.css" rel="stylesheet" />
        <link href="../../../Skins/Fluid/stylesheets/styles.css" rel="stylesheet" />
        <link href="../../../Skins/Fluid/stylesheets/tablet.css" rel="stylesheet" />
        <link href="../../../Skins/Fluid/stylesheets/mobile.css" rel="stylesheet" />
        <link href="../../resources/stylesheets/prism.css" rel="stylesheet" />
        <style>/*&lt;meta /&gt;*/

.button.topic-ratings-button
{
	-pie-background: transparent url('../../../Skins/Default/Stylesheets/Images/star-full.png') no-repeat center center;
}

.button.separator-button
{
	-pie-background: linear-gradient(#ffffff, #ececec);
}

.button.edit-user-profile-button
{
	-pie-background: url('../../../Skins/Default/Stylesheets/Images/edit-profile.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.print-button
{
	-pie-background: url('../../../Skins/Default/Stylesheets/Images/printer.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.expand-all-button
{
	-pie-background: url('../../../Skins/Default/Stylesheets/Images/expand.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.collapse-all-button
{
	-pie-background: url('../../../Skins/Default/Stylesheets/Images/collapse.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.needs-pie
{
	behavior: url('../../../Resources/Scripts/PIE-no-motw.htc');
}

</style>
        <link href="../../resources/stylesheets/mainstyles.css" rel="stylesheet" />
        <script src="../../../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../../../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../../../Resources/Scripts/require.min.js">
        </script>
        <script src="../../../Resources/Scripts/require.config.js">
        </script>
        <script src="../../../Resources/Scripts/foundation.6.2.3_custom.js">
        </script>
        <script src="../../../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../../../Resources/Scripts/MadCapAll.js">
        </script>
        <script src="../../../Resources/Scripts/MadCapSearch.Google.js">
        </script>
    </head>
    <body>
        <div class="foundation-wrap off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper="">
                <aside class="off-canvas position-right" id="offCanvas" data-off-canvas="" data-position="right" data-mc-ignore="true">
                    <ul class="off-canvas-drilldown vertical menu off-canvas-list" data-drilldown="" data-mc-back-link="Back" data-mc-css-tree-node-expanded="is-drilldown-submenu-parent" data-mc-css-tree-node-collapsed="is-drilldown-submenu-parent" data-mc-css-sub-menu="vertical menu slide-in-right is-drilldown-submenu" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="True" data-mc-include-back="True" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.drilldown" data-mc-toc="True">
                    </ul>
                </aside>
                <div class="off-canvas-content inner-wrap" data-off-canvas-content="">
                    <div data-sticky-container="" class="title-bar-container">
                        <nav class="title-bar tab-bar sticky" data-sticky="" data-options="marginTop:0" style="width:100%" data-sticky-on="small" data-mc-ignore="true">
                            <div class="middle title-bar-section outer-row clearfix">
                                <div class="menu-icon-container relative clearfix">
                                    <button class="menu-icon" data-toggle="offCanvas"><span></span>
                                    </button>
                                </div>
                            </div>
                            <div class="title-bar-layout outer-row">
                                <div class="logo-wrapper"><a class="logo" href="../../home.htm" alt="Logo"></a>
                                </div>
                                <div class="navigation-wrapper nocontent">
                                    <ul class="navigation clearfix" data-mc-css-tree-node-has-children="has-children" data-mc-css-sub-menu="sub-menu" data-mc-expand-event="mouseenter" data-mc-top-nav-menu="True" data-mc-max-depth="3" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                        <li class="placeholder" style="visibility:hidden"><a>placeholder</a>
                                        </li>
                                    </ul>
                                </div>
                                <div class="nav-search-wrapper">
                                    <div class="nav-search row">
                                        <form>
                                            <div id="nc42Ukn6i0SFt9N8ZAsCwg" class="search-bar search-bar-container needs-pie">
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </nav>
                    </div>
                    <section class="main-section">
                        <div class="row outer-row sidenav-layout">
                            <div class="sidenav-wrapper">
                                <div class="sidenav-container">
                                    <ul class="off-canvas-accordion vertical menu sidenav" data-accordion-menu="" data-mc-css-tree-node-expanded="is-accordion-submenu-parent" data-mc-css-tree-node-collapsed="is-accordion-submenu-parent" data-mc-css-sub-menu="vertical menu accordion-menu is-accordion-submenu nested" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="False" data-mc-include-back="False" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.accordionMenu" data-mc-toc="True" data-mc-side-nav-menu="True">
                                    </ul>
                                </div>
                            </div>
                            <div class="body-container" data-mc-content-body="True">
                                <script src="../../resources/prism.js">
                                </script>
                                <div class="search-container">
                                    <form>
                                        <div id="qvMu-SEh9Uqv4HMNFGQrzA" class="search-bar search-bar-container needs-pie _Skins_SearchTopics mc-component">
                                        </div>
                                    </form>
                                </div>
                                <div class="row collapse">
                                    <div class="top-bar">
                                        <div class="nocontent">
                                            <div class="MCBreadcrumbsBox_0 breadcrumbs" data-mc-breadcrumbs-divider=" &gt; " data-mc-breadcrumbs-count="3" data-mc-toc="True"><span class="MCBreadcrumbsPrefix">You are here: </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="topic-layout">
                                        <div>
                                            <div class="side-menu">
                                                <div data-sticky-container="" id="ZpTfWIjuykOYtxtmSb-E6w">
                                                    <div class="sticky sticky-menu" style="width:100%" data-sticky="" data-top-anchor="ZpTfWIjuykOYtxtmSb-E6w:top" data-bottom-anchor="contentBody:bottom" data-sticky-on="small" data-scroll-container-on="small">
                                                        <ul class="nocontent menu _Skins_SideMenu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/master.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="side-menu">
                                                <div class="buttons popup-container clearfix topicToolbarProxy _Skins_TopicToolbar mc-component nocontent" style="mc-topic-toolbar-items: ;">
                                                    <div class="button-group-container-left">
                                                        <div class="button-group star-buttons loading feedback-topic-required">
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                            <div class="button star-button topic-ratings-empty-button" data-state1-class="topic-ratings-empty-button" data-state2-class="topic-ratings-button" title="Click a star to rate this topic" data-state1-title="Click a star to rate this topic" data-state2-title="Click a star to rate this topic">
                                                                <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="topic rating" />
                                                            </div>
                                                        </div>
                                                        <div class="button-separator feedback-topic-required">
                                                        </div>
                                                        <button class="button feedback-required login-button" id="normalLoginBtn" data-state1-class="login-button" data-state2-class="edit-user-profile-button" title="Login" data-state1-title="Login">
                                                            <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="login" />
                                                        </button>
                                                        <button class="button needs-pie print-button" title="Print">
                                                            <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="print" />
                                                        </button>
                                                        <button class="button needs-pie expand-all-button" data-state1-class="expand-all-button" data-state2-class="collapse-all-button" data-state2-title="Collapse all" title="Expand all" data-state1-title="Expand all">
                                                            <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="expand all" />
                                                        </button>
                                                    </div>
                                                </div>
                                                <h1>Tutorial - Search Custom Setup</h1>
                                                <p>There might be instances when you need to go beyond product search or you have very specific requirements regarding search. You’re not tied to the basic mapping that ships with Spryker. You can easily roll your own and set up custom analyzer very easily. The underlaying library that gets used by Spryker is called <a href="https://github.com/ruflin/Elastica" target="_blank" title="Elastica " alt="Elastica ">Elastica</a> and you can use it to set up custom mapping and analyzers as you like.</p>
                                                <h2>Custom Analyzers</h2>
                                                <p>The Elasticsearch indexes get installed during installation of collectors. To add custom analyzers you will need to override <var>Spryker\Zed\Collector\Business\Internal\InstallElasticsearch</var>. Let’s create a quick example setting up a German analyzer.</p>
                                                <p>Create a file called <var>InstallElasticsearch.php</var> inside the <var>Collector</var> <span class="Generalbundle/module">(Undefined variable: General.bundle/module)</span> on the project level</p><pre><code class="language-PHP line-numbers">touch src/Pyz/Zed/Collector/Business/Internal/InstallElasticsearch.php</code></pre>
                                                <p>Override the <var>createIndex()</var> method and provide your custom analyzer setup along with index creation.</p>
                                                <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click to expand the code sample</a></span>
                                                    <div class="MCDropDownBody dropDownBody"><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\Collector\Business\Internal;

use Spryker\Zed\Collector\Business\Internal as SprykerInstallElasticsearch;

class InstallElasticsearch extends SprykerInstallElasticsearch 
{
    
    protected createIndex() {
        $index = $this-&gt;client-&gt;getIndex($this-&gt;indexName);

        if (!$index-&gt;exists()) {
            $index-&gt;create(
                [
                    'number_of_shards' =&gt; 4,
                    'number_of_replicas' =&gt; 1,
                    'analysis' =&gt; [
                        'filter' =&gt; [
                            'german_stop' =&gt; [
                                'type' =&gt; 'stop',
                                'stopwords' =&gt; '_german_',
                            ],
                            'german_stemmer' =&gt; [
                                'type' =&gt; 'stemmer',
                                'language' =&gt; 'light_german',
                            ],
                        ],
                    ],
                    'analyzer' =&gt; [
                        'german' =&gt; [
                            'tokenizer' =&gt; 'standard',
                            'filter' =&gt; [
                                'lowecase',
                                'german_stop',
                                'german_normalization',
                                'german_stemmer',
                            ]
                        ],
                    ],
                ]
            );
        }
    }

}</code></pre>
                                                    </div>
                                                </div>
                                                <p class="note">The <var>$index</var> variable holds an instance of <var>Elastica\Index</var>. The array that is passed to the <var>create()</var> method of that instance can contain any Elasticsearch setting. As you can see from the example above it gets used to set up the number of replicas and shards as well.</p>
                                                <p>Elasticsearch provides analyzers for a lot of languages. Detailed information on how to properly set up analyzers can be found in the documentation at <a href="https://www.elastic.io/" target="_blank" title="Elastic" alt="Elastic">http://www.elastic.io/</a></p>
                                                <h2>Custom Mapping</h2>
                                                <p>If you have diverging requirements for product search than what Spryker is offering, you might want to set up a custom mapping. Either you have different requirements regarding aggregations/facets or you want a more fine grained document with multiple fields for each product attribute. It’s easy to override the default mapping and create your own.</p>
                                                <p>The default mapping is defined in <var>Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch</var> and you will have to extend this class on project level.</p>
                                                <p>Create a file called <var>InstallProductSearch.php</var> inside the <var>ProductSearch</var> <span class="Generalbundle/module">(Undefined variable: General.bundle/module)</span> on project level</p><pre><code class="language-PHP line-numbers">touch src/Pyz/Zed/ProductSearch/Business/Internal/InstallProductSearch.php</code></pre>
                                                <p>Override <var>createProductType()</var> method and install your custom mapping</p>
                                                <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click to expand the code sample</a></span>
                                                    <div class="MCDropDownBody dropDownBody"><pre><code class="language-PHP line-numbers">&lt;?php
namespace Pyz\Zed\ProductSearch\Business\Internal;

use Elastica\Index;
use Elastica\Type\Mapping;
use Elastica\Type;
use Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch as SprykerInstallProductSearch;

class InstallProductSearch extends SprykerInstallProductSearch
{

    /**
     * @throws \RuntimeException
     *
     * @param \Elastica\Index $index
     *
     * @return void
     */
    protected function createProductType(Index $index)
    {
        $index = $this-&gt;client-&gt;getIndex($this-&gt;indexName);

        if (!$index-&gt;exists()) {
            throw new \RuntimeException(sprintf('Index %s is missing', $this-&gt;indexName));
        }

        $type = $index-&gt;getType($this-&gt;indexType);

        if ($type-&gt;exists() === true) {
            return;
        }

        $mapping = new Mapping($type);
        $mapping-&gt;setProperties([
            'title' =&gt; [
                'type' =&gt; 'string',
                'analyzer' =&gt; 'german',
            ],
            'description' =&gt; [
                'type' =&gt; 'string',
                'analyzer' =&gt; 'german',
            ],
            'price' =&gt; [
                'type' =&gt; 'integer',
            ],
        ]);
        $mapping-&gt;send();
    }</code></pre>
                                                    </div>
                                                </div>
                                                <h2>Extend Existing Mapping</h2>
                                                <p>If you want to use the existing mapping that comes with Spryker but want to add additional fields, or change properties for existing fields, you will also need to override <var>Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch</var>. Follow the steps in the previous paragraph and add the file to your project level implementation.</p>
                                                <p>Instead of replacing the implementation of <var>createProductType()</var> we will extend it. Unfortunately there’s a pitfall here. Elasticseach doesn’t allow to alter a mapping since that would lead to an inconsistent state of documents that are already indexed. However, there’s a workaround to still achieve out goal. We can load the currently installed mapping, delete the document type (which will also remove all documents of that type from the index) and then reinstall the mapping.</p>
                                                <p>Here’s a simple example that uses our previously defined <var>german</var> analyzer for the <var>full-text</var> field</p>
                                                <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click to expand the code sample</a></span>
                                                    <div class="MCDropDownBody dropDownBody"><pre><code class="language-PHP line-numbers">&lt;?php

namespace Pyz\Zed\ProductSearch\Business\Internal;

use Elastica\Index;
use Elastica\Type\Mapping;
use Elastica\Type;
use Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch as SprykerInstallProductSearch;

class InstallProductSearch extends SprykerInstallProductSearch
{

    /**
     * @param \Elastica\Index $index
     *
     * @return void
     */
    protected function createProductType(Index $index)
    {
        parent::createProductType($index);

        $type = $index-&gt;getType($this-&gt;indexType);
        $mappingProperties = $this-&gt;getExistingMappingProperties($type);

        $mappingProperties['full-text'] = [
            'type' =&gt; 'string',
            'analyzer' =&gt; 'german',
        ];

        $type-&gt;delete();

        $mapping = new Mapping($type);
        $mapping-&gt;setProperties($mappingProperties);
        $mapping-&gt;send();
    }

    /**
     * @param Elastica\Type $type
     *
     * @return array
     */
    protected function getExistingMappingProperties(Type $type)
    {
        $mapping = $type-&gt;getMapping();

        return $mapping[this-&gt;indexType]['properties'];
    }

}</code></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section><a data-close="true"></a>
                </div>
            </div>
            <script>/* <![CDATA[ */$(document).foundation();/* ]]> */</script>
        </div>
    </body>
</html>