<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" MadCap:lastBlockDepth="2" MadCap:lastHeight="1409" MadCap:lastWidth="1756" style="">
    <head>
    </head>
    <body>
        <h1>Multi-Term Auto Completion</h1>
        <p>Term completion is a feature where a user gets suggestions for search terms and matching search results as he types the query. We call a completion multi-term when it is able to combine terms from different attributes in an open-ended fashion. In the below example, a user entered “fortis” (a brand) and started typing “hammer” (a category):
</p>
        <p>
            <img src="../Resources/Images/completion.png" title="Completion" alt="Completion" class="Thumbnail" />
        </p>
        <p>After completing “hammer”, the search would suggest more terms found in documents containing both “fortis” and “hammer”.

</p>
        <p>The Elasticsearch API offers the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters-completion.html" target="_blank">completion suggester</a>, which works great in many cases but has one major drawback in that it can only suggest fixed terms that are saved to Elasticsearch during index time. So in the example above, the terms “fortis” and “hammer” as well as both compound variations, i.e. “fortis hammer” and “hammer fortis”, would have to be indexed.

</p>
        <p>We therefore recommend indexing all terms for which you want to offer auto completion (category names, facet values, brands and other categorial terms) in one field called completion_terms:

"<var>completion_terms</var>":</p><pre><code class="language-PHP line-numbers">[
  "Fortis",
  "1000",
  "1250",
  "1500",
  "2000",
  "Fäustel",
  "Handwerkzeug",
  "Hammer"
]
</code></pre>
        <p>The field is analyzed with a very simple analyzer, which is based on the Elasticsearch keyword tokenizer (the analyzer is only used to remove some stop words).
</p><pre><code class="language-PHP line-numbers">"completion_terms": {
  "type": "string",
  "analyzer": "completion_analyzer"
}
</code></pre>
        <p>In order to have products match partial search terms (like “fortis ham”), we apply an <a href="https://www.elastic.co/guide/en/elasticsearch/guide/master/_index_time_search_as_you_type.html#_edge_n_grams_and_postcodes" target="_blank">edge_ngram</a> filter to a field that contains the same data as completion_terms. Only documents that match the current search query are considered when building auto completion terms. Auto completion terms are fetched by aggregating on the completion_terms field and showing terms with the highest number of occurrences. All of this is happening in one query. The aggregation part of that query (the part used for autocompletion) looks as follows:

</p><pre><code class="language-PHP line-numbers">"aggs": {
  "autocomplete": {
    "terms": {
      "field": "completion_terms",
      "size": 100
    }
  }
}
</code></pre>
        <p>The main benefit of this approach is that it is possible to continuously suggest new terms as a user types. The main drawback is speed–The out-of-the-box completion suggester is much more optimized for speed.

 

</p>
    </body>
</html>